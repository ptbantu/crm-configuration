BANTU CRM Database Relationships (Complete ER Overview)

ASCII ER Sketch (all tables)

  vendors ──> products (vendor_id)
  product_categories ──> products (category_id)
  
  customers ──(self)──> customers (parent_customer_id)
  customers ──> contacts (customer_id)
  customers ──> visa_records (customer_id)
  customers ──> orders (customer_id)
  
  users ──> customers (owner_user_id: 内部客户)
  users ──> customers (agent_user_id: 渠道客户)
  users ──> orders (sales_user_id: 创建订单)
  
  products ──> orders (product_id)
  order_statuses ──> orders (status_id)
  
  orders ──> order_assignments (order_id)
  orders ──> order_stages (order_id)
  orders ──> deliverables (order_id)
  orders ──> payments (order_id)
  
  order_stages ──> deliverables (order_stage_id)
  
  users ──> order_assignments (assigned_to_user_id)
  users ──> order_stages (assigned_to_user_id)
  users ──> payments (confirmed_by)
  
  users ──> user_roles ──> roles


Foreign Keys by Table (Complete List)

- vendors
  (no foreign keys)

- product_categories
  (no foreign keys)

- products
  - vendor_id -> vendors(id) ON DELETE SET NULL
  - category_id -> product_categories(id) ON DELETE SET NULL

- customers
  - owner_user_id -> users(id) ON DELETE SET NULL (内部客户所有者)
  - agent_user_id -> users(id) ON DELETE SET NULL (渠道客户所有者)
  - parent_customer_id -> customers(id) ON DELETE SET NULL (组织层级)

- contacts
  - customer_id -> customers(id) ON DELETE CASCADE

- visa_records
  - customer_id -> customers(id) ON DELETE SET NULL

- users
  (no foreign keys)

- roles
  (no foreign keys; global roles)

- user_roles
  - user_id -> users(id) ON DELETE CASCADE
  - role_id -> roles(id) ON DELETE CASCADE

- order_statuses
  (no foreign keys; global status definitions)

- orders
  - customer_id -> customers(id) ON DELETE RESTRICT
  - product_id -> products(id) ON DELETE SET NULL
  - sales_user_id -> users(id) ON DELETE RESTRICT
  - status_id -> order_statuses(id) ON DELETE SET NULL
  - created_by -> users(id) ON DELETE SET NULL
  - updated_by -> users(id) ON DELETE SET NULL

- order_assignments
  - order_id -> orders(id) ON DELETE CASCADE
  - assigned_to_user_id -> users(id) ON DELETE RESTRICT
  - assigned_by_user_id -> users(id) ON DELETE SET NULL

- order_stages
  - order_id -> orders(id) ON DELETE CASCADE
  - assigned_to_user_id -> users(id) ON DELETE SET NULL
  - created_by -> users(id) ON DELETE SET NULL
  - updated_by -> users(id) ON DELETE SET NULL

- deliverables
  - order_id -> orders(id) ON DELETE CASCADE
  - order_stage_id -> order_stages(id) ON DELETE SET NULL
  - uploaded_by -> users(id) ON DELETE SET NULL
  - verified_by -> users(id) ON DELETE SET NULL

- payments
  - order_id -> orders(id) ON DELETE RESTRICT
  - confirmed_by -> users(id) ON DELETE SET NULL
  - created_by -> users(id) ON DELETE SET NULL


Unique Constraints and Important Indexes

- vendors
  - ux_vendors_external_id(external_id) WHERE external_id IS NOT NULL
  - ix_vendors_email(email), ix_vendors_phone(phone)

- product_categories
  - UNIQUE(code) [global]

- products
  - ux_products_code(code) WHERE code IS NOT NULL
  - CHECK: prices >= 0

- customers
  - ux_customers_code(code) WHERE code IS NOT NULL
  - CHECK: customer_source_type IN ('own', 'agent')
  - CHECK: customer_type IN ('individual', 'organization')
  - CHECK: ownership validation (own requires owner_user_id, agent requires agent_user_id)

- contacts
  - ux_contacts_one_primary_per_customer(customer_id) WHERE is_primary = TRUE
  - ix_contacts_email(email), ix_contacts_phone(phone)

- visa_records
  - CHECK: fx_rate >= 0, payment_amount >= 0

- users
  - UNIQUE(username)
  - UNIQUE(email) [nullable]
  - INDEX email, phone

- roles
  - UNIQUE(code)

- order_statuses
  - UNIQUE(code)

- orders
  - ux_orders_number(order_number) WHERE order_number IS NOT NULL
  - CHECK: amounts >= 0

- order_stages
  - CHECK: progress_percent >= 0 AND progress_percent <= 100

- deliverables
  - CHECK: file_size >= 0


Audit and Timestamps

- All core tables include created_at, updated_at with trigger set_updated_at() maintaining updated_at on UPDATE.
- Source-system provenance columns (e.g., *_external, *_at_src) exist on: products, customers, visa_records, vendors.
- Audit fields (created_by, updated_by) exist on: orders, order_stages, deliverables, contacts, payments.


Business Rules Summary

1. Customer classification: 
   - customer_source_type: 'own' (内部) or 'agent' (渠道)
   - customer_type: 'individual' (个人) or 'organization' (组织)
2. Order workflow: draft -> submitted -> assigned -> in_progress -> completed
3. Contacts: Only for organization customers, one primary contact per organization
4. Order stages: Progress tracked 0-100%, can be assigned to users
5. Payments: Can be full, partial, or refund; requires confirmation


Table Count: 17 tables
- User & Role: users, roles, user_roles (3)
- Product: vendors, product_categories, products (3)
- Customer: customers, contacts, customer_sources, customer_channels (4)
- Order: order_statuses, orders, order_assignments, order_stages, deliverables, payments (6)
- Legacy: visa_records (1)

Total Relationships: 30+ foreign keys


Notes

- Category normalization: products.category_id is optional; category_code kept for compatibility.
- External IDs: *_external fields allow traceability to source systems and staged imports.
- Order statuses: Global (shared across all users).
- Customer ownership: Internal customers (own) require owner_user_id (SALES), agent customers require agent_user_id (AGENT).
